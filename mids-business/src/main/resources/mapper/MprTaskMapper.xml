<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yinhai.mids.business.mapper.MprTaskMapper">
    <resultMap id="toDoTask" type="com.yinhai.mids.business.entity.dto.MprToDoTask">
        <id column="apply_id" jdbcType="VARCHAR" property="applyId"/>
        <result column="series_id" jdbcType="VARCHAR" property="seriesId"/>
        <result column="mpr_types" jdbcType="VARCHAR" property="mprTypes"/>
        <result column="compute_series_ids" jdbcType="VARCHAR" property="computeSeriesIds"/>
    </resultMap>

    <select id="queryTodoTasks" resultMap="toDoTask">
        SELECT a.apply_id,
               b.series_id,
               group_concat(a.mpr_type)          mpr_types,
               group_concat(a.compute_series_id) compute_series_ids
        FROM tb_mpr_task a
                 JOIN tb_compute_series_info b ON a.compute_series_id = b.compute_series_id
        WHERE (a.task_status = 0 OR (a.task_status = 1 AND a.mpr_time &lt; now() - INTERVAL 5 MINUTE))
          AND NOT exists(SELECT 1
                         FROM tb_task_lock
                         WHERE task_type = 3
                           AND expire_time >= now()
                           AND item_id = a.apply_id)
        GROUP BY a.apply_id, b.series_id, b.create_time
        ORDER BY b.create_time
    </select>
</mapper>